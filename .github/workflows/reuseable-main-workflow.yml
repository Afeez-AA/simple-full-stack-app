
name: Main CI/CD Pipeline

on:
  push:
    branches: [ci-cd]
    paths: .github/workflows/reuseable-main-workflow.yml
  workflow_dispatch:

# env:
#   REGISTRY: docker.io
#   DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
#   FRONTEND_IMAGE: frontend-simple-app
#   BACKEND_IMAGE: backend-simple-app
#   IMAGE_TAG: 1.0.${{ github.run_number }}

jobs:
  security-scan:
    uses: ./.github/workflows/reuseable-codeql-workflow.yml
    secrets: inherit

  container-scan:
    uses: ./.github/workflows/reuseable-trivy-workflow.yml
    secrets: inherit
    with:
      registry: 'docker.io'
      frontend_image: 'frontend-simple-app'
      backend_image: 'backend-simple-app'
      image_tag: '1.0.${{ github.run_number }}'
    needs: security-scan

  build-deploy:
    uses: ./.github/workflows/reuseable-build-deploy-workflow.yml
    secrets: inherit
    with:
      registry: 'docker.io'
      frontend_image: 'frontend-simple-app'
      backend_image: 'backend-simple-app'
      image_tag: '1.0.${{ github.run_number }}'
    needs: container-scan